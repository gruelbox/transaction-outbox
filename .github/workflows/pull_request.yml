name: Pull request

on:
  pull_request:
    branches: [ master ]

jobs:
  build:
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Build with Maven
        run: mvn -B package

      - name: Updating README and creating pull request branch
        run: |
          set -e
          revision=${GITHUB_REF##*/}
          git checkout -b "${revision}-update-version"
          echo "Updating READMEs"
          sed -i "s_\(<version>\)[^<]*_\1${revision}_g" README.md
          sed -i "s_\(<version>\)[^<]*_\1${revision}_g" transactionoutbox-guice/README.md
          sed -i "s_\(<version>\)[^<]*_\1${revision}_g" transactionoutbox-jooq/README.md
          sed -i "s_\(<version>\)[^<]*_\1${revision}_g" transactionoutbox-spring/README.md
          sed -i "s_\(implementation 'com.gruelbox:transactionoutbox-core:\)[^']*_\1${revision}_g" README.md
          sed -i "s_\(implementation 'com.gruelbox:transactionoutbox-guice:\)[^']*_\1${revision}_g" transactionoutbox-guice/README.md
          sed -i "s_\(implementation 'com.gruelbox:transactionoutbox-jooq:\)[^']*_\1${revision}_g" transactionoutbox-jooq/README.md
          sed -i "s_\(implementation 'com.gruelbox:transactionoutbox-spring:\)[^']*_\1${revision}_g" transactionoutbox-spring/README.md

      - name: Create Pull Request
        uses: gruelbox/create-pull-request@v2
        with:
          commit-message: "Update versions in READMEs [skip ci]"
          title: Update versions in READMEs
          body: Updates the versions in the README files following the release
          branch: update-readme-versions
